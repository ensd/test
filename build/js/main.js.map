{"version":3,"sources":["main.js","reviewForm.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACzJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"main.js","sourcesContent":["let statsList = {\n    impression_rate: \"Впечатление\",\n    reliability_rate: \"Соответствие\",\n    safety_rate: \"Надёжность\",\n  };\n\nfunction getData(key) {\n  let data = JSON.parse(localStorage.getItem('data'));\n\n  return data[key] || data;\n}\n\nfunction setData(data) {\n  localStorage.setItem('data', JSON.stringify(data));\n}\n\nfunction renderStatus(item, $template) {\n  switch(+item.status) {\n    case 0:\n      $template.find('.reviews__review-status').text('На модерации').addClass('reviews__review-status_opacity');\n      break;\n    \n    case 1:\n      $template.find('.reviews__review-status').text('Опубликован');\n      break;\n\n    case 2:\n      $template.find('.reviews__review-status').text('Не опубликован').addClass('reviews__review-status_muted');\n      break;\n\n    default:\n      $template.find('.reviews__review-status').text('На модерации').addClass('reviews__review-status_opacity');\n      break;\n  }\n}\n\nfunction getRate(item) {\n  return ((+item.impression_rate + +item.reliability_rate + +item.safety_rate) / 3).toFixed(1);\n}\n\nfunction renderRate(item) {\n  let $template = $($('#rate-template').html())\n    , value = getRate(item);\n\n  $template.data('value', value);\n  $template.find('.rate__value').text(value);\n\n  $template.find('.rate__star').each(function(i, el) {\n    let diff = value - i;\n\n    if (diff > 1) {\n      $(el).find('.rate__indicator').css('width', '100%');\n    } else if (diff < 0) {\n      $(el).find('.rate__indicator').css('width', '0');\n    } else {\n      $(el).find('.rate__indicator').css('width', (diff * 100).toFixed(0) + '%');\n    }\n  });\n\n  return $template;\n}\n\nfunction renderPhoto(item) {\n  let $template = $($('#reviews__review-image-template').html());\n\n  $template.attr('data-lightbox', 'reviews__review-photo_' + item.review_id).attr('href', item.image);\n  $template.find('.reviews__review-image').attr('src', item.image);\n\n  return $template;\n}\n\nfunction renderReview(item) {\n  let $template = item.parent_id ? $($('#reviews__item_child-template').html()) : $($('#reviews__item_main-template').html())\n    , product = getData('product').find(function(el) {\n        return +el.id == +item.product_id;\n      })\n    , children = getData('review').reduce(function(arr, current) {\n        if (+current.parent_id == +item.id) arr.push(current);\n        return arr;\n      }, [])\n    , images = getData('review_has_image').reduce(function(arr, current) {\n        if (+current.review_id == +item.id) arr.push(current);\n        return arr;\n      }, []);\n\n  $template.attr('data-id', item.id);\n  $template.find('.reviews__review-text').html(item.text);\n  $template.find('.reviews__review-date').html(item.created_at);\n  \n  renderStatus(item, $template);\n\n  $(images).each(function(i, el) {\n    $template.find('.reviews__review-images').append(renderPhoto(el));\n  });\n\n  if (+item.status == 2) {\n    $template.find('.reviews__review-text').html('К сожалению, ваш отзыв не прошёл модерацию.').addClass('text-muted');\n    $template.find('.reviews__review-rate, .reviews__review-stats, .js-reviews__button_add').remove();\n  }\n\n  if (item.parent_id) return $template;\n\n  $template.find('.reviews__product-name').html(product.name);\n  $template.find('.reviews__product-image').attr('src', product.image).attr('alt', product.name);\n  $template.find('.reviews__review-rate').html(renderRate(item));\n  \n  $(Object.entries(statsList)).each(function(i, el) {\n    $template.find('.reviews__review-stat').eq(i).html(el[1] + ': <b>' + item[el[0]] + '</b>');\n  });\n\n  $(children).each(function(i, el) {\n    $template.append(renderReview(el));\n  });\n\n  return $template;\n}\n\nfunction renderReviews() {\n  let wWidth = $(window).width()\n    , reviews = getData('review').reduce(function(arr, current) {\n      if (+current.parent_id == 0) arr.push(current);\n      return arr;\n    }, []);\n\n  $('.reviews__body').html('');\n\n  $(reviews).each(function(i, el) {\n    let $html = renderReview(el);\n\n    $('.reviews__body').append($html);\n    $html.find('.reviews__review-text').each(function() {\n      if ($(this).height() > (wWidth < 768 ? 120 : 60 )) $(this).addClass('reviews__review-spoiler');\n    });\n  });\n}\n\nfunction init() {\n  $.getJSON('db/data.json', function(res) {\n\n    setData(res);\n\n    renderReviews();\n  });\n}\n\n$(function() {\n  let $body = $('body');\n  \n  init();\n\n  $body.on('click', '.js-reviews__review-toggle', function() {\n    $(this).prev().removeClass('reviews__review-spoiler');\n  });\n});","function getRandomID() {\n  return Math.floor(Math.random() * Math.floor(999));\n}\n\n$(function() {\n  let $body = $('body');\n\n  moment.locale('ru');\n \n  $body.on('mouseenter', '.rate_field .rate__star', function() {\n    let index = $(this).index()\n      , $container = $(this).closest('.rate__stars');\n\n    $container.find('.rate__star').removeClass('rate__star_active');\n\n    for (i = 0; i < index; i++) {\n      $container.find('.rate__star').eq(i).addClass('rate__star_active');\n    }\n  });\n\n  $body.on('mouseleave', '.rate_field .rate__star', function() {\n    let $container = $(this).closest('.rate__stars')\n      , index = $container.find('input:checked').val(); \n\n    $container.find('.rate__star').removeClass('rate__star_active');\n\n    for (i = 0; i < index; i++) {\n      $container.find('.rate__star').eq(i).addClass('rate__star_active');\n    }\n  });\n\n  $body.on('click', '.js-remove', function() {\n    let $this = $(this);\n\n    if ($this.closest('.js-files').find('.form-control').length > 1) {\n        $this.closest('.row').remove();\n    } else {\n        $this.closest('.row').find('input').val('');\n    }\n  });\n\n  $body.on('click', '.js-add', function() {\n      $('.js-files').append($('#add-file-template').html());\n  });\n\n  $body.on('click', '.js-reviews__button_add', function() {\n    let id = $(this).closest('.reviews__item').data('id')\n      , $template = $($('#add-review-template').html());\n\n    $template.find('[name=parent_id]').val(id);\n    $template.find('.js-files').html($('#add-file-template').html());\n\n    $('#reviewModal').find('.modal-title').text('Дополнить отзыв');\n    $('#reviewModal').find('.modal-body').html($template);\n    $('#reviewModal').modal('show');\n  });\n\n  $body.on('click', '.js-reviews__button_create', function() {\n    let $template = $($('#create-review-template').html())\n      , products = getData('product');\n\n    $template.find('[name=parent_id]').val(0);\n\n    $(products).each(function(i, el) {\n      $template.find('[name=product_id]').append('<option value=\"' + el.id + '\">' + el.name + '</option>');\n    });\n\n    $template.find('.js-form__rate').each(function() {\n      let $rateTemplate = $($('#rate-template').html());\n\n      $rateTemplate.find('[name=rate]').attr('name', $(this).data('attr'));\n      $rateTemplate.find('.rate__star').addClass('rate__star_active');\n      $rateTemplate.addClass('rate_field');\n      $(this).html($rateTemplate);\n    });\n\n    $template.find('.js-files').html($('#add-file-template').html());\n\n    $('#reviewModal').find('.modal-title').text('Оставить отзыв');\n    $('#reviewModal').find('.modal-body').html($template);\n    $('#reviewModal').modal('show');\n  });\n\n  $body.on('click', '.js-submit', function() {\n    let hasError = false\n      , data = getData()\n      , review = {}\n      , $form = $(this).closest('.modal').find('form');\n    \n    $form.find('.form-control').removeClass('is-invalid');\n\n    $form.find('input:not([type=file]), textarea, select').each(function() {\n      if ($(this).val() == '') {\n        $(this).addClass('is-invalid');\n        hasError = true;\n      }\n    });\n\n    if (!hasError) {\n      review = $form.serializeArray().reduce(function(i, obj) {\n          i[obj.name] = obj.value;\n          return i;\n        }, {id: getRandomID()});\n\n      review.created_at = moment().format('D MMMM, YYYY');\n      review.parent_id = +review.parent_id;\n      review.product_id = +review.product_id;\n      \n      data.review.push(review);\n      \n      $form.find('[type=file]').each(function() {\n        if (this.files && this.files[0]) {\n          let reviewHasImage = {\n            id: getRandomID(),\n            review_id: review.id,\n            image: URL.createObjectURL(this.files[0])\n           };\n          \n           data.review_has_image.push(reviewHasImage);\n        }\n      });\n\n      setData(data);\n\n      renderReviews();\n\n      $('#reviewModal').modal('hide');\n    }\n  });\n});"]}